name: Build SWT JARs with Natives

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  build-linux-x64:
    name: Build Linux x86_64
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: false

    - name: Install GTK dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -qq -y build-essential git
        sudo apt-get install -qq -y libgtk-3-dev libgtk-4-dev freeglut3-dev webkit2gtk-driver libwebkitgtk-6.0-4

    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Set up Maven
      uses: stCarolas/setup-maven@v5
      with:
        maven-version: 3.9.11

    - name: Build with Maven
      env:
        GTK_XCFLAGS: '-Wno-deprecated-declarations'
      run: |
        mvn clean install -Dnative=gtk.linux.x86_64 --batch-mode -V -U -e --threads 1C -DskipTests=true

    - name: Upload Linux x64 JARs
      uses: actions/upload-artifact@v4
      with:
        name: swt-linux-x86_64
        path: |
          binaries/org.eclipse.swt.gtk.linux.x86_64/target/*.jar
          bundles/org.eclipse.swt/target/*.jar

  build-linux-aarch64:
    name: Build Linux aarch64
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: false

    - name: Set up QEMU for cross-compilation
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    - name: Install GTK dependencies and cross-compilation tools
      run: |
        sudo dpkg --add-architecture arm64

        # Backup and replace sources.list with arch-specific configuration
        sudo mv /etc/apt/sources.list /etc/apt/sources.list.backup
        CODENAME=$(lsb_release -cs)

        # Create new sources.list for amd64 only
        cat <<EOF | sudo tee /etc/apt/sources.list
        deb [arch=amd64] http://archive.ubuntu.com/ubuntu/ $CODENAME main restricted universe multiverse
        deb [arch=amd64] http://archive.ubuntu.com/ubuntu/ $CODENAME-updates main restricted universe multiverse
        deb [arch=amd64] http://archive.ubuntu.com/ubuntu/ $CODENAME-security main restricted universe multiverse
        deb [arch=amd64] http://archive.ubuntu.com/ubuntu/ $CODENAME-backports main restricted universe multiverse
        EOF

        # Add ARM64 sources pointing to ports
        cat <<EOF | sudo tee /etc/apt/sources.list.d/arm64.list
        deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ $CODENAME main restricted universe multiverse
        deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ $CODENAME-updates main restricted universe multiverse
        deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ $CODENAME-security main restricted universe multiverse
        deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ $CODENAME-backports main restricted universe multiverse
        EOF

        sudo apt-get update -qq
        sudo apt-get install -qq -y build-essential git gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
        sudo apt-get install -qq -y libgtk-3-dev:arm64 libgtk-4-dev:arm64 freeglut3-dev:arm64 libwebkitgtk-6.0-4:arm64

    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Set up Maven
      uses: stCarolas/setup-maven@v5
      with:
        maven-version: 3.9.11

    - name: Build with Maven
      env:
        GTK_XCFLAGS: '-Wno-deprecated-declarations'
        CC: aarch64-linux-gnu-gcc
        CXX: aarch64-linux-gnu-g++
        PKG_CONFIG_PATH: /usr/lib/aarch64-linux-gnu/pkgconfig
      run: |
        mvn clean install -Dnative=gtk.linux.aarch64 --batch-mode -V -U -e --threads 1C -DskipTests=true

    - name: Upload Linux aarch64 JARs
      uses: actions/upload-artifact@v4
      with:
        name: swt-linux-aarch64
        path: |
          binaries/org.eclipse.swt.gtk.linux.aarch64/target/*.jar
          bundles/org.eclipse.swt/target/*.jar

  build-windows-x64:
    name: Build Windows x86_64
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Pull Windows binaries (WebView2)
      run: |
        git lfs pull --include='/binaries/org.eclipse.swt.win32.win32.x86_64/WebView2Loader.dll'

    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Set up Maven
      uses: stCarolas/setup-maven@v5
      with:
        maven-version: 3.9.11

    - name: Build with Maven
      run: mvn clean install "-Dnative=win32.win32.x86_64" --batch-mode -V -U -e --threads 1C "-DskipTests=true"

    - name: Upload Windows x64 JARs
      uses: actions/upload-artifact@v4
      with:
        name: swt-windows-x86_64
        path: |
          binaries/org.eclipse.swt.win32.win32.x86_64/target/*.jar
          bundles/org.eclipse.swt/target/*.jar

  build-windows-arm64:
    name: Build Windows ARM64
    runs-on: windows-latest  # Note: Use windows-11-arm64 when available on your runner
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Pull Windows ARM64 binaries (WebView2)
      run: |
        git lfs pull --include='/binaries/org.eclipse.swt.win32.win32.aarch64/WebView2Loader.dll'

    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Set up Maven
      uses: stCarolas/setup-maven@v5
      with:
        maven-version: 3.9.11

    - name: Build with Maven
      run: mvn clean install "-Dnative=win32.win32.aarch64" --batch-mode -V -U -e --threads 1C "-DskipTests=true"

    - name: Upload Windows ARM64 JARs
      uses: actions/upload-artifact@v4
      with:
        name: swt-windows-aarch64
        path: |
          binaries/org.eclipse.swt.win32.win32.aarch64/target/*.jar
          bundles/org.eclipse.swt/target/*.jar

  build-macos-x64:
    name: Build macOS x86_64 (Intel)
    runs-on: macos-15-intel  # Intel runner
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: false

    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Set up Maven
      uses: stCarolas/setup-maven@v5
      with:
        maven-version: 3.9.11

    - name: Build with Maven
      run: |
        mvn clean install -Dnative=cocoa.macosx.x86_64 --batch-mode -V -U -e --threads 1C -DskipTests=true

    - name: Upload macOS Intel JARs
      uses: actions/upload-artifact@v4
      with:
        name: swt-macos-x86_64
        path: |
          binaries/org.eclipse.swt.cocoa.macosx.x86_64/target/*.jar
          bundles/org.eclipse.swt/target/*.jar

  build-macos-aarch64:
    name: Build macOS aarch64 (Apple Silicon)
    runs-on: macos-latest  # ARM64 runner
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: false

    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Set up Maven
      uses: stCarolas/setup-maven@v5
      with:
        maven-version: 3.9.11

    - name: Build with Maven
      run: |
        mvn clean install -Dnative=cocoa.macosx.aarch64 --batch-mode -V -U -e --threads 1C -DskipTests=true

    - name: Upload macOS ARM JARs
      uses: actions/upload-artifact@v4
      with:
        name: swt-macos-aarch64
        path: |
          binaries/org.eclipse.swt.cocoa.macosx.aarch64/target/*.jar
          bundles/org.eclipse.swt/target/*.jar

  build-macos-universal:
    name: Build macOS Universal Binary
    needs: [build-macos-x64, build-macos-aarch64]
    runs-on: macos-latest
    steps:
    - name: Checkout (for scripts)
      uses: actions/checkout@v4

    - name: Download macOS Intel artifacts
      uses: actions/download-artifact@v4
      with:
        name: swt-macos-x86_64
        path: macos-x86_64

    - name: Download macOS ARM artifacts
      uses: actions/download-artifact@v4
      with:
        name: swt-macos-aarch64
        path: macos-aarch64

    - name: List downloaded artifacts
      run: |
        echo "=== Intel artifacts ==="
        find macos-x86_64 -type f
        echo ""
        echo "=== ARM artifacts ==="
        find macos-aarch64 -type f

    - name: Create universal JAR
      run: |
        chmod +x .github/scripts/create-universal-macos-jar.sh

        echo "Looking for fragment JARs (contain natives)..."
        # Find the fragment JARs that contain the native libraries (exclude -sources.jar)
        INTEL_JAR=$(find macos-x86_64 -path "*/binaries/*/target/org.eclipse.swt.cocoa.macosx.x86_64-*.jar" ! -name "*-sources.jar" | head -1)
        ARM_JAR=$(find macos-aarch64 -path "*/binaries/*/target/org.eclipse.swt.cocoa.macosx.aarch64-*.jar" ! -name "*-sources.jar" | head -1)

        if [ -z "$INTEL_JAR" ] || [ -z "$ARM_JAR" ]; then
          echo "ERROR: Could not find fragment JAR files"
          echo "Intel JAR: $INTEL_JAR"
          echo "ARM JAR: $ARM_JAR"
          echo ""
          echo "Available files:"
          find macos-x86_64 -name "*.jar"
          find macos-aarch64 -name "*.jar"
          exit 1
        fi

        echo "Found Intel JAR: $INTEL_JAR"
        echo "Found ARM JAR: $ARM_JAR"

        mkdir -p universal
        OUTPUT_JAR="universal/org.eclipse.swt.cocoa.macosx.universal.jar"

        .github/scripts/create-universal-macos-jar.sh "$INTEL_JAR" "$ARM_JAR" "$OUTPUT_JAR"

    - name: Upload macOS Universal artifacts
      uses: actions/upload-artifact@v4
      with:
        name: swt-macos-universal
        path: universal/*.jar

  create-release-bundle:
    name: Create Release Bundle
    needs: [build-linux-x64, build-linux-aarch64, build-windows-x64, build-windows-arm64, build-macos-x64, build-macos-aarch64, build-macos-universal]
    runs-on: ubuntu-latest
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: all-platforms

    - name: List downloaded artifacts
      run: |
        echo "Downloaded artifacts:"
        find all-platforms -type f

    - name: Create release structure
      run: |
        mkdir -p release
        cp -r all-platforms/* release/
        cd release
        zip -r ../swt-all-platforms.zip .

    - name: Upload combined bundle
      uses: actions/upload-artifact@v4
      with:
        name: swt-all-platforms-bundle
        path: swt-all-platforms.zip
        retention-days: 90
